<!DOCTYPE html>
<meta charset="utf-8">
<style>

svg {
  text-align: center;
}

path {
  stroke: #fff;
  fill-rule: evenodd;
}

text {
  font-family: Arial;
  font-size: 1em;
  color: #fff !important;
}

#container{
  text-align: center;
  position: relative;
}

.vertical-align {
  display: flex;
  align-items: center;
}

#explanation {
  z-index: 2;
  position: absolute;
  top: 305px;
  left:395px;
  text-align: center;
  width: 140px;
  color: #666;
}
#genre_name{
  font-weight: bold
}
#percentage {
  font-size: 2.5em;
}

</style>
<body>
<div class="container-fluid">
  <div class="row vertical-align">
    <div class="col-md-9"> 
      <div id="container">
        <div id="explanation" style="visibility: hidden;">
          <span id="percentage"></span><br/>
          of <span id="genre_name"></span> videos on Youtube are accessible*
        </div>
        <!-- the D3 svg gets appended here -->
      </div>
    </div>
    <div class="col-md-3">
      <ul>
        <li>Click a category in the table to see it in detail</li>
        <li>Click the center to return to the main view</li>
        <li><b>*</b>Captioning makes video content accessable to the Deaf and Hard of Hearing, to search engine optimization, and also to be translated from English into other languages</li>
      </ul>
      <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

        <div class="panel panel-default">
          <div class="panel-heading" role="tab" id="headingOne">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                How to Caption Your Videos
              </a>
            </h4>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
            <div class="panel-body">
             (Note: this process is not available on mobile devices)
             <br><br>
              <b>Step 1:</b> Navigate to YouTube's Video Manager, which is found in the Creator Studio.
              <br>
              <img src="figures/10.png" alt="Screenshot of Video Manager location" width = "150" title="YouTube's Video Manager location" style="vertical-align:middle">
              <br><br>
              <b>Step 2:</b> The option to add Subtitles and CC is under the down arrow next to the Edit button of the video you wish to change.
              <br>
              <img src="figures/1.png" alt="Screenshot of Subtitles and CC menu location" width = "250" title="Subtitles and CC menu location" style="vertical-align:middle"> 
              <br><br>
              <b>Step 3:</b> If you haven't already, you will be prompted to set the most spoken language in the video. 
              <br>
              <img src="figures/2.png" alt="Select video's primary language" width = "250" title="Video language selection" style="vertical-align:middle">
              <br><br>
              <b>Step 4:</b> Subtitles can be added in whatever language you prefer, using one of three methods:
              <br>
                <i>Upload a file:</i> allows you to upload a text transcript or timed subtitles file which should contain both text and time codes for when each line of text should be displayed. Position and style information can also be included. 
                <br>
                <i>Transcribe and set timings:</i> using this method, you can type everything that is said in the video and let YouTube automatically line up the text with the content of the video. Once it is finished, you can adjust the timing and content of the subtitles. 
                <br>
                <i>Create new subtitles or CC:</i> finally, you can type out the subtitles line by line and set the timing by hand. 
                <br>
                <img src="figures/5.png" alt="Screenshot Subtitle/CC options" width = "250" title="Options for adding Subtitles/CC to YouTube videos" style="vertical-align:middle">
                <br><br>
                
              Congratulations, your video can now reach many more people! 
            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading" role="tab" id="headingTwo">
            <h4 class="panel-title">
              <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                Subtitles vs. Closed Captioning
              </a>
            </h4>
          </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
            <div class="panel-body">
              <p>
              In European nations, there is no significant distinction between subtitles and closed captions. However, in the U.S. and Canada, subtitles refer to a translation of the dialogue and assume the audience can hear. Closed captioning, on the other hand, is meant to replace all sound, not just dialogue.<br>
              Despite this official distinction, YouTube appears to make no distinction between the two. 
              <br>
              <a href="http://www.examiner.com/article/closed-captioning-vs-subtitles-and-what-you-should-know">Source</a>
              <br><br>
              </p>
            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading" role="tab" id="headingThree">
            <h4 class="panel-title">
              <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                Resources
              </a>
            </h4>
          </div>
          <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
            <div class="panel panel-default">

              <a href="https://amara.org/en/">Amara.org</a> allows users to create captions for videos they don't own and share the videos with others. 
              <br><br>
              <a href="http://dhcc.org/">dhcc: Deaf-Hearing Communication Centre</a> provides interpreters, sensitivity training, and ASL classes. 
              <br><br>
              <a href="https://support.google.com/youtube/answer/2734796?hl=en" title="This link will take you to the YouTube Subtitle/CC support page."> Official YouTube Subtitle/CC support </a>
               <br><br>
               <a href="https://support.google.com/youtube/answer/2734698?hl=en" title="This link will take you to YouTube's support page for uploading subtitles and CC."> Official YouTube Subtitle/CC upload support </a>
               <br><br>
               <a href="https://creatoracademy.withgoogle.com/page/lesson/captions" title="This link will take you to the YouTube Creator Academy page on reaching a global audience through Subtitles/CC."> Learn more about reaching a global audience through Subtitles/CC </a>
              
            </div>
          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading" role="tab" id="headingFour">
            <h4 class="panel-title">
              <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                About
              </a>
            </h4>
          </div>
          <div id="collapseFour" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFour">
            <div class="panel-body">
              <p>This data visualization was created by Hannah Bown, Rita Zevallos, and Jonah Schwartz, with the advice of Neil McDevitt (Executive Director of the <a href="http://dhcc.org/">dhcc</a>), during the 2015 evoHaX hackathon.</p>
              <p>Data was collected with the help of the <a href="http://bl.ocks.org/mbostock/5944371">Youtube Data API</a>. This open source sunburst flare was originally created by <a href="http://bl.ocks.org/mbostock/5944371">John Stasko</a></p> 

              <p>In the future, we'd like to expand this chart so that it updates dynamically with daily information on captioned vs. uncaptioned YouTube videos. We would also like to add an alternate viewing mode that sorts the categories by highest caption ratio instead of by highest number of total videos. </p>
       
      </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<img src="" id="alt_chart_image" alt="THIS IS ALT TEXT FOR THE GRAPH">

<link rel="stylesheet" type="text/css" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var width = 900,
    height = 700,
    radius = Math.min(width, height) / 2.1;

var x = d3.scale.linear()
    .range([0, 2 * Math.PI]);

var y = d3.scale.linear()
    .range([0, radius]);

var color = d3.scale.category20c();

// var color = d3.scale.linear()
//     .domain([0,40])
//     .range(["yellow", "cyan"]);

var svg = d3.select("#container").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")");

var partition = d3.layout.partition()
    .value(function(d) { return d.size; });

var arc = d3.svg.arc()
    .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
    .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
    .innerRadius(function(d) { return Math.max(0, y(d.y)); })
    .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

d3.json("dummy.json", function(error, root) {

  var g = svg.selectAll("g")
      .data(partition.nodes(root))
    .enter().append("g");
  
  var total_vids = root.value;
  var idx = 0;

  var path = g.append("path")
    .attr("d", arc)
    //.style("fill", function(d) { return color((d.children ? d : d.parent).name); })
    .attr("fill", function (d) {
      //debugger; 
      //console.log((parseInt(color(d.value).substring(1,7),16)).toString(16));
      if (d.name === "flare") return "#ffffff"; 
      // else if (d.name === "with annotations") return ("#"+(parseInt(color(d.parent.value).substring(1,7),16) + 6000).toString(16));
      // else if (d.name === "without annotations") return ("#"+(parseInt(color(d.parent.value).substring(1,7),16) - 6000).toString(16));
      else if (d.name === "with annotations") return color(d.parent.value/total_vids*90);
      else if (d.name === "without annotations") return color(d.parent.value/total_vids*90);
      else {
        return color(d.value/total_vids*90);}
        ;})
      // else if (d.name === "with annotations") return color(3*idx+10);
      // else if (d.name === "without annotations") return color(3*idx);
      // else {
      //   idx++;
      //   return color(3*idx+5);}
      //   ;})
    .style("opacity", function(d){ 
      if (d.name === "without annotations") return 0.33;
      if (d.name === "with annotations") return 0.66;
      else return 1;
    })
    .on("click", click);
    //.attr("display", function(d) { return d.depth ? null : "none"; });

  absolute_total = root.value;

  absolute_total_captioned = 0.0;
  for (i=0; i<root.children.length; i++){
    child = root.children[i];

    if (child.children[0].name === "with annotations"){
      absolute_total_captioned += child.children[0].value;
    }
    else {absolute_total_captioned += child.children[1].value;}
  }

  changeCenterText("", absolute_total_captioned, absolute_total);

  var text = g.append("text")
    .attr("transform", function(d) { 
      //console.log(computeTextRotation(d));
      if (d.name === "flare") return null;
      else return "rotate(" + computeTextRotation(d) + ")"; })
    .attr("x", function(d) {
      if (d.name === "flare") return -103;
      else return y(d.y); })
    .attr("dx", "6") // margin
    .attr("dy", ".35em") // vertical-align
    .text(function(d) { 
      if (d.name === "flare") return "";
      else if (d.depth > 1) return ""; 
      else return d.name; });

  function changeCenterText(nameString, total_captioned, total){
    var percentageString = String((total_captioned/total*100).toFixed(1))+"\%";

    d3.select("#percentage")
      .text(percentageString);

    d3.select('#genre_name')
      .text(nameString);

    d3.select("#explanation")
        .style("visibility", "");

    // var alt_text = "%s of %s videos on Youtube are accessible*"%(percentageString, nameString);

    var alt_text = percentageString + " of " + nameString + " videos on Youtube are accessible";

    console.log(alt_text); 
    d3.select('#alt_chart_image').attr('alt',alt_text);
  }

  function click(d) {
    // todo: calculate percentage

    if (d.name === "flare"){
      changeCenterText("", absolute_total_captioned, absolute_total);
    } else {

      var total_genre = d.value;

      if (!d.children){
          d=d.parent;
          total_genre = d.value;
      }
      if (d.children[0].name === "with annotations"){
          var total_captioned = d.children[0].value;
      }
      else {var total_captioned = d.children[1].value;};

      changeCenterText(d.name, total_captioned, total_genre);
    }

    // fade out all text elements
    text.transition().attr("opacity", 0);

    path.transition()
      .duration(750)
      .attrTween("d", arcTween(d))
      .each("end", function(e, i) {
          // check if the animated element's data e lies within the visible angle span given in d
          if (e.x >= d.x && e.x < (d.x + d.dx)) {
            // get a selection of the associated text element
            var arcText = d3.select(this.parentNode).select("text");
            // fade in the text element and recalculate positions
            arcText.transition().duration(750)
              .attr("opacity", 1)
              .attr("transform", function() { return "rotate(" + computeTextRotation(e) + ")" })
              // .attr("transform", function() { 
              //   if(e.name != "flare"){
              //     return ("rotate(" + 0 + ")");
              //   }
              //   else {
              //     return ("rotate(" + computeTextRotation(e) + ")");
              //   }
              // })
              .attr("x", function(d) { return y(d.y); });
          }
      });
  }
});

d3.select(self.frameElement).style("height", height + "px");

// Interpolate the scales!
function arcTween(d) {
  var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
      yd = d3.interpolate(y.domain(), [d.y, 1]),
      yr = d3.interpolate(y.range(), [d.y ? 150 : 0, radius]);
  return function(d, i) {
    return i
        ? function(t) { return arc(d); }
        : function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
  };
}

function computeTextRotation(d) {
  return (x(d.x + d.dx / 2) - Math.PI / 2) / Math.PI * 180;
}

</script>